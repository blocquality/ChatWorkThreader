# ChatWork Threader

ChatWorkのメッセージをスレッド形式でツリー表示するChrome拡張機能です。複雑な会話の流れを一目で把握し、チームワークを効率化します。

## 🎯 機能概要

ChatWork Threaderは、ChatWorkの返信関係にあるメッセージをReddit/YouTubeコメント欄風のツリー構造で視覚化します。

### コア機能

- **スレッドツリー表示**: 返信関係のあるメッセージを階層的なツリー構造で表示
- **リアルタイム更新**: メッセージの追加・削除を自動検知して表示を更新
- **クロスセッション保持**: ルームごとにフィルター設定・折りたたみ状態を保存

---

## 🖥️ ユーザーインターフェース

### スレッドパネル

画面右側にスライドインするパネルで、以下の要素で構成されています：

| 要素 | 説明 |
|------|------|
| **リサイズハンドル** | パネル左端のドラッグ可能なハンドル（三本線アイコン）。パネル幅を550px〜画面幅90%の範囲で調整可能 |
| **発言者フィルター** | プルダウンで特定の発言者のスレッドのみ表示（ルームごとに保存） |
| **My Participation Only** | 自分が参加（返信元/返信先）しているスレッドのみ表示するトグルスイッチ |
| **Flat** | フラット表示モード切り替え。ONにすると全ての返信を1階層で表示（深いネストを簡略化） |
| **検索バー** | スレッド内のメッセージをリアルタイム検索。ユーザー名、本文、引用、To宛先を検索対象 |
| **リフレッシュボタン** | スレッド情報を手動で再取得 |
| **クローズボタン** | パネルを閉じる |

### トグルボタン

画面右下に常時表示されるフローティングボタン。

- **アイコン**: 拡張機能のアイコン画像
- **ショートカット表示**: 「Shift+S」のショートカットキーを表示
- **クリック**: スレッドパネルの表示/非表示を切り替え

### 「スレッドで表示」ボタン

ChatWorkのメッセージ一覧で、スレッドに含まれるメッセージの左上に表示されるアイコンボタン。

- **表示条件**: メッセージが返信関係（返信元または返信先）を持つ場合のみ表示
- **クリック動作**: スレッドパネルを開き、該当メッセージまでスクロール＆ハイライト

---

## 🎨 表示仕様

### メッセージカード

各メッセージは以下の情報を表示：

| 項目 | 説明 |
|------|------|
| **アバター** | ユーザーのプロフィール画像（24x24px、円形） |
| **ユーザー名** | メッセージ送信者の表示名 |
| **タイムスタンプ** | 「yyyy/MM/dd hh:mm」形式 |
| **返信トグル** | ルートメッセージのみ表示。返信数と展開/折りたたみ切り替え |
| **メッセージ本文** | 本文テキスト（URLは自動リンク化） |
| **引用表示** | 引用メッセージがある場合、発言者情報付きで表示 |
| **ファイルプレビュー** | 添付ファイルのプレビューボタン |
| **外部リンク** | 外部URLとプレビューボタン |

### 自分宛てメッセージのハイライト

自分宛て（メンション）のメッセージは特別な表示：

- **背景色**: 薄い緑色（#E4F6F3）
- **右ボーダー**: 緑色の4pxボーダー（#57CAB3）
- **判定ロジック**: ChatWorkの `mentioned` クラスを検出

### ツリー接続線

Reddit/YouTubeコメント欄風の視覚的な接続線：

- **縦線**: 同じ階層の後続メッセージがある場合、アバター中心から下方向に伸びる
- **L字線**: 親メッセージのアバター中心から子メッセージのアバターへ接続
- **色**: 通常時グレー（#e0e0e0）、ホバー時濃いグレー（#909090）

### パネル幅の自動計算

ツリーの最大階層に応じてパネル幅を自動調整：

```
パネル幅 = 380px + (最大階層 × 44px)
```

- **最小幅**: 550px
- **最大幅**: 画面幅の90%
- **フラットモード時**: 固定550px

---

## 🔍 検索機能

### 検索対象

- メッセージ本文
- ユーザー名
- 引用メッセージ
- To宛先ユーザー

### 検索動作

| 操作 | 動作 |
|------|------|
| **入力** | 200msのデバウンス後にリアルタイム検索 |
| **Enter** | 即座に検索実行 |
| **Escape** | 検索クリア |
| **▲/▼ボタン** | 検索結果間を循環ナビゲート |
| **クリアボタン** | 検索クエリをクリア |

### 検索結果表示

- **マッチしたメッセージ**: 黄色背景でハイライト
- **マッチしなかったスレッド**: 半透明（opacity: 0.35）で表示
- **現在位置**: オレンジ色のアウトラインで強調
- **カウント表示**: 「1/10」形式で現在位置/全件数を表示

---

## 📎 ファイル・リンクプレビュー

### ファイルプレビュー

ChatWorkに添付されたファイルに対してプレビューボタンを表示：

- **対応形式**: 画像ファイル（ChatWorkのプレビュー機能を利用）
- **表示形式**: 「📎 ファイル名 (サイズ) [Preview]」
- **動作**: クリックでChatWork本体のプレビューモーダルを起動

### 外部リンクプレビュー

外部URLに対してChatWorkのプレビュー機能がある場合、プレビューボタンを表示：

- **対応サービス**: ChatWorkがプレビューをサポートする外部サービス（Google Docs等）
- **表示形式**: URLの直後に「[Preview]」ボタン
- **動作**: クリックでChatWork本体のプレビュー機能を起動

### プレビュー表示中の動作

プレビューモーダルが開いている間、スレッドパネルを一時的に非表示にして操作性を確保：

- **復元トリガー**: クリック、Escキー、または30秒経過

---

## ⌨️ ショートカットキー

| キー | 動作 |
|------|------|
| **Shift + S** | スレッドパネルの表示/非表示を切り替え |

※ 入力フィールド（テキストボックス、textarea、contenteditable要素）にフォーカスがある場合は無効

---

## 💾 データ保存

### 保存先

Chrome Storage API（`chrome.storage.local`）を使用

### 保存データ

| キー | 内容 | スコープ |
|------|------|----------|
| `cw-threader-toggle-states` | スレッドの折りたたみ状態 | ルームID × スレッドMID |
| `cw-threader-room-settings` | ルーム設定（発言者フィルター、フラットモード、参加フィルター） | ルームID |

### 保存タイミング

- フィルター設定変更時
- スレッド折りたたみ/展開時

---

## 📐 技術仕様

### メッセージ収集

ChatWorkのDOM構造を解析してメッセージデータを収集：

| 属性 | 取得方法 |
|------|----------|
| **メッセージID (mid)** | `data-mid` 属性 |
| **ルームID (rid)** | `data-rid` 属性 |
| **返信元メッセージID** | `data-cwtag="[rp aid=XXX to=ROOMID-MESSAGEID]"` を解析 |
| **ユーザー名** | `[data-testid="timeline_user-name"]` 要素 |
| **アバターURL** | `.userIconImage` 要素の `src` 属性 |
| **タイムスタンプ** | `[data-tm]` 属性 |
| **メッセージ本文** | `<pre>` 要素内のテキスト（引用・返信バッジ等を除外） |
| **引用メッセージ** | `[data-cwtag^="[qt"]`、`.chatQuote` 要素 |
| **To宛先** | `[data-cwtag^="[to"]` 要素 |
| **送信者AID** | `[data-aid]` 属性、またはアバターURL から抽出 |

### 自分判定ロジック

#### 自分宛てメッセージ (isToMe)

以下のいずれかの条件でtrueと判定：

1. メッセージ要素に `mentioned` クラスがある
2. クラス名に `mention` を含む（styled-components対応）
3. 親要素に `timelineMessage--mention` クラスがある

#### 自分が送信したメッセージ (isFromMe)

以下のいずれかの条件でtrueと判定：

1. 編集ボタン（`[data-testid="message-edit-button"]` 等）が存在する
2. 削除ボタン（`[data-testid="message-delete-button"]` 等）が存在する
3. 親要素に `myMessage`、`my-message` 等のクラスがある

### スレッド構築アルゴリズム

1. 全メッセージを収集し、`mid` をキーとしたMapに格納
2. 返信関係（`parentMid`）を解析し、`replyMap`（子→親）と`childrenMap`（親→子リスト）を構築
3. ルートメッセージ（親を持たないメッセージ）を起点にツリーを再帰構築
4. 返信元が見つからない場合はプレースホルダーメッセージを生成

### プレースホルダーメッセージ

返信元メッセージがDOMに存在しない場合（スクロール範囲外、削除済み等）：

- **ユーザー名**: 子メッセージの `parentUserName` または「不明なユーザー」
- **メッセージ本文**: 「（メッセージを読み込めませんでした）」
- **表示スタイル**: 半透明、イタリック体、クリック無効

### MutationObserver

以下のDOM変更を監視して自動更新：

- **メッセージ追加/削除**: `data-mid` 属性を持つ要素の変更
- **ルーム切り替え**: URL（ハッシュ）の変更
- **デバウンス**: 500ms間隔で処理を間引き

---

## 🚀 使い方

### 基本操作

1. ChatWork（https://www.chatwork.com/）にアクセス
2. チャットルームを開く
3. 右下に表示されるトグルボタンをクリック（または `Shift + S`）
4. 右側にスレッドパネルが開く
5. スレッド内のメッセージをクリックすると、該当メッセージにスクロール

### フィルタリング

1. **発言者フィルター**: ヘッダーのプルダウンから特定ユーザーを選択
2. **自分参加フィルター**: 「My Participation Only」をONにして自分が関わるスレッドのみ表示
3. **フラットモード**: 「Flat」をONにして深いネストを簡略化

### 検索

1. 検索バーにキーワードを入力
2. マッチしたメッセージが黄色でハイライト
3. ▲/▼ボタンで結果間を移動

---

## 📦 インストール方法

### 開発者モードでのインストール

1. このリポジトリをクローン
   ```bash
   git clone https://github.com/blocquality/ChatWorkThreader.git
   ```

2. Chromeで `chrome://extensions/` を開く

3. 右上の「デベロッパーモード」をONにする

4. 「パッケージ化されていない拡張機能を読み込む」をクリック

5. クローンしたフォルダを選択

---

## 📁 ファイル構成

```
ChatWorkThreader/
├── manifest.json      # 拡張機能マニフェスト（Manifest V3）
├── content.js         # コンテンツスクリプト（メインロジック）
├── styles.css         # スタイルシート（1075行）
├── popup.html         # ツールバーアイコンクリック時のポップアップ
├── icon128.png        # 拡張機能アイコン（128x128）
├── icons/             # アイコン画像ディレクトリ
│   ├── icon16.png     # ファビコン用
│   ├── icon48.png     # 拡張機能管理画面用
│   └── icon128.png    # Chrome Web Store用
└── README.md          # このドキュメント
```

---

## 🛠️ 開発

### 前提条件

- Chrome / Edge などのChromiumベースブラウザ
- Git

### ローカル開発

1. コードを編集
2. `chrome://extensions/` で拡張機能を再読み込み（更新ボタンをクリック）
3. ChatWorkのページをリロードして動作確認

### デバッグ

- 開発者ツール（F12）のConsoleでログを確認
- `console.log` 文はコメントアウト済み（必要に応じて有効化）

---

## 🔧 Manifest V3 設定

```json
{
  "manifest_version": 3,
  "name": "ChatWork Threader",
  "version": "1.0.0",
  "permissions": ["activeTab", "scripting", "storage"],
  "host_permissions": ["https://*.chatwork.com/*"],
  "content_scripts": [{
    "matches": ["https://*.chatwork.com/*"],
    "js": ["content.js"],
    "css": ["styles.css"],
    "run_at": "document_idle"
  }]
}
```

---

## 📝 メッセージの種類

| 種類 | 内部タイプ値 | 説明 |
|------|-------------|------|
| 独立メッセージ | 1 | スレッドに含まれない独立したメッセージ（パネルには表示されない） |
| 返信元 (Root) | 2 | 誰かから返信がついているメッセージ |
| 返信 (Reply) | 3 | 他のメッセージに対する返信 |
| 返信元+返信 (Both) | 4 | 返信でありかつ、さらに返信がついているメッセージ |

---

## 🔄 更新履歴

### v1.0.0

- 初回リリース
- スレッドツリー表示機能
- 発言者フィルター
- 自分参加フィルター
- フラットモード
- 検索機能
- ファイル/リンクプレビュー連携
- ショートカットキー対応
- ルーム別設定保存

---

## 📜 ライセンス

MIT License

---

## 🤝 コントリビューション

Issue や Pull Request は歓迎します！

### バグ報告

1. 再現手順を明記
2. 期待される動作と実際の動作を記載
3. ブラウザのバージョンを記載

### 機能提案

1. 提案する機能の概要
2. ユースケース・利用シーン
3. 可能であれば実装方針
