# ChatWork Threader

ChatWorkのメッセージをスレッド形式でツリー表示するChrome拡張機能です。複雑な会話の流れを一目で把握し、チームワークを効率化します。

## 🎯 機能概要

ChatWork Threaderは、ChatWorkの返信関係にあるメッセージをReddit/YouTubeコメント欄風のツリー構造で視覚化します。

### コア機能

- **スレッドツリー表示**: 返信関係のあるメッセージを階層的なツリー構造で表示
- **リアルタイム更新**: メッセージの追加・削除を自動検知して表示を更新
- **クロスセッション保持**: ルームごとにフィルター設定・折りたたみ状態を保存

---

## 🖥️ ユーザーインターフェース

### スレッドパネル

画面右側にスライドインするパネルで、以下の要素で構成されています：

| 要素 | 説明 |
|------|------|
| **リサイズハンドル** | パネル左端のドラッグ可能なハンドル（三本線アイコン）。パネル幅を550px〜画面幅90%の範囲で調整可能 |
| **タブUI** | スレッド / 設定 / ヘルプの3タブ構成 |
| **発言者フィルター** | プルダウンで特定の発言者のスレッドのみ表示（ルームごとに保存） |
| **My Participation Only** | 自分が参加（返信元/返信先）しているスレッドのみ表示するトグルスイッチ |
| **Flat** | フラット表示モード切り替え。ONにすると全ての返信を1階層で表示（深いネストを簡略化） |
| **検索バー** | スレッド内のメッセージをリアルタイム検索。ユーザー名、本文、引用、To宛先を検索対象 |
| **リフレッシュボタン** | スレッド情報を手動で再取得 |
| **クローズボタン** | パネルを閉じる |

### トグルボタン

画面右下に常時表示されるフローティングボタン。

- **アイコン**: 拡張機能のアイコン画像（icon128.png）
- **ショートカット表示**: 「Shift+S」のショートカットキーを表示
- **クリック**: スレッドパネルの表示/非表示を切り替え
- **ホバー時**: 1.05倍に拡大

### ツールバーポップアップ

Chromeツールバーの拡張機能アイコンをクリックすると表示されるポップアップ（popup.html）。

- **使い方ガイド**: 基本的な操作方法を表示
- **バッジ凡例**: Root / Reply / Root+Reply の意味を説明
- **バージョン情報**: 現在のバージョンを表示

### メッセージカードの機能ボタン

各メッセージカードには以下のボタンが表示されます：

| ボタン | 説明 |
|--------|------|
| **ピン止め** | スレッドをピン止めしてパネル上部に固定表示。ルームごとに保存 |
| **コピー** | メッセージ本文をクリップボードにコピー。成功時にチェックマークを表示 |
| **元メッセージ追跡** | プレースホルダー（返信元が未読み込み）の場合に表示。クリックでChatWork本体を高速スクロールして元メッセージを探索 |

### 設定タブ

パネルの「設定」タブで以下のグローバル設定を変更できます：

| 設定項目 | 説明 |
|----------|------|
| **言語** | 日本語 / Englishを切り替え |
| **テーマ** | ライト / ダーク / システム連動 |
| **折りたたみ時の最大行数** | スレッドヘッドを折りたたんだ際の表示行数制限（1〜100） |

設定は自動保存され、`chrome.storage.sync` で同期されます。

### ヘルプタブ

パネルの「ヘルプ」タブで以下の情報を確認できます：

- 基本的な使い方
- 機能一覧
- バッジの説明
- ショートカットキー

### 「スレッドで表示」ボタン

ChatWorkのメッセージ一覧で、スレッドに含まれるメッセージの左上に表示されるアイコンボタン。

- **表示条件**: メッセージが返信関係（返信元または返信先）を持つ場合のみ表示
- **クリック動作**: スレッドパネルを開き、該当メッセージまでスクロール＆ハイライト

---

## 🎨 表示仕様

### メッセージカード

各メッセージは以下の情報を表示：

| 項目 | 説明 |
|------|------|
| **アバター** | ユーザーのプロフィール画像（24x24px、円形） |
| **ユーザー名** | メッセージ送信者の表示名 |
| **タイムスタンプ** | 「yyyy/MM/dd hh:mm」形式 |
| **返信トグル** | ルートメッセージのみ表示。返信数と展開/折りたたみ切り替え |
| **メッセージ本文** | 本文テキスト（URLは自動リンク化） |
| **引用表示** | 引用メッセージがある場合、発言者情報付きで表示 |
| **ファイルプレビュー** | 添付ファイルのプレビューボタン |
| **外部リンク** | 外部URLとプレビューボタン |

### 自分宛てメッセージのハイライト

自分宛て（メンション）のメッセージは特別な表示：

- **背景色**: 薄い緑色（#E4F6F3）
- **右ボーダー**: 緑色の4pxボーダー（#57CAB3）
- **判定ロジック**: ChatWorkの `mentioned` クラスを検出

### ツリー接続線

Reddit/YouTubeコメント欄風の視覚的な接続線：

- **縦線**: 同じ階層の後続メッセージがある場合、アバター中心から下方向に伸びる
- **L字線**: 親メッセージのアバター中心から子メッセージのアバターへ接続
- **色**: 通常時グレー（#e0e0e0）、ホバー時濃いグレー（#909090）

### パネル幅の自動計算

ツリーの最大階層に応じてパネル幅を自動調整：

```
パネル幅 = 380px + (最大階層 × 44px)
```

- **最小幅**: 550px
- **最大幅**: 画面幅の90%
- **フラットモード時**: 固定550px
- **モバイル対応**: 画面幅500px以下では全幅（100%）表示

### スレッドの並び順

スレッドは以下の優先順位でソート：

1. **ピン止めスレッドが最上部に固定**
2. ルートメッセージのタイムスタンプで比較（**新しい順**）
3. タイムスタンプがない場合はメッセージID（mid）で比較

子メッセージは**古い順**（昇順）でソート。

### ChatWork本体との連携

スレッドパネル表示時、ChatWork本体のレイアウトを自動調整：

- **メッセージ欄**: 右マージンを追加してパネル分のスペースを確保
- **概要欄との連携**: 概要欄（`_subContentArea`）の幅を考慮し、重複分は移動距離から減算
- **アニメーション**: 0.25秒のイージングでスムーズに移動

---

## 🔍 検索機能

### 検索対象

- メッセージ本文
- ユーザー名
- 引用メッセージ
- To宛先ユーザー

### 検索動作

| 操作 | 動作 |
|------|------|
| **入力** | 200msのデバウンス後にリアルタイム検索 |
| **Enter** | 即座に検索実行 |
| **Escape** | 検索クリア |
| **▲/▼ボタン** | 検索結果間を循環ナビゲート |
| **クリアボタン** | 検索クエリをクリア |

### 検索結果表示

- **マッチしたメッセージ**: 黄色背景でハイライト
- **マッチしなかったスレッド**: 半透明（opacity: 0.35）で表示
- **現在位置**: オレンジ色のアウトラインで強調
- **カウント表示**: 「1/10」形式で現在位置/全件数を表示

---

## 📎 ファイル・リンクプレビュー

### ファイルプレビュー

ChatWorkに添付されたファイルに対してプレビューボタンを表示：

- **対応形式**: 画像ファイル（ChatWorkのプレビュー機能を利用）
- **表示形式**: 「📎 ファイル名 (サイズ) [Preview]」
- **動作**: クリックでChatWork本体のプレビューモーダルを起動

### 外部リンクプレビュー

外部URLに対してChatWorkのプレビュー機能がある場合、プレビューボタンを表示：

- **対応サービス**: ChatWorkがプレビューをサポートする外部サービス（Google Docs等）
- **表示形式**: URLの直後に「[Preview]」ボタン
- **動作**: クリックでChatWork本体のプレビュー機能を起動

### プレビュー表示中の動作

プレビューモーダルが開いている間、スレッドパネルとトグルボタンを一時的に非表示にして操作性を確保：

- **非表示対象**: スレッドパネル、トグルボタンの両方
- **復元トリガー**: クリック、Escキー、または30秒経過
- **連打対策**: プレビューボタン自体のクリックでは復元しない

---

## ⌨️ ショートカットキー

| キー | 動作 |
|------|------|
| **Shift + S** | スレッドパネルの表示/非表示を切り替え |

※ 入力フィールド（テキストボックス、textarea、contenteditable要素）にフォーカスがある場合は無効

---

## 💾 データ保存

### 保存先

Chrome Storage API（`chrome.storage.local`）を使用

### 保存データ

| キー | 内容 | スコープ |
|------|------|----------|
| `cw-threader-toggle-states` | スレッドの折りたたみ状態 | ルームID × スレッドMID |
| `cw-threader-room-settings` | ルーム設定（発言者フィルター、フラットモード、参加フィルター） | ルームID |
| `pinned_{roomId}` | ピン止めスレッドのメッセージIDリスト | ルームID |

#### chrome.storage.sync（グローバル設定）

| キー | 内容 |
|------|------|
| `cw-threader-settings` | 言語、テーマ、折りたたみ行数 |

保存されるデータが変更された場合、popup.jsからの設定変更もリアルタイムにコンテンツスクリプトに反映されます。

### 保存タイミング

- フィルター設定変更時
- スレッド折りたたみ/展開時

---

## 📐 技術仕様

### メッセージ収集

ChatWorkのDOM構造を解析してメッセージデータを収集：

| 属性 | 取得方法 |
|------|----------|
| **メッセージID (mid)** | `data-mid` 属性 |
| **ルームID (rid)** | `data-rid` 属性 |
| **返信元メッセージID** | `data-cwtag="[rp aid=XXX to=ROOMID-MESSAGEID]"` を解析 |
| **ユーザー名** | `[data-testid="timeline_user-name"]` 要素 |
| **アバターURL** | `.userIconImage` 要素の `src` 属性 |
| **タイムスタンプ** | `[data-tm]` 属性 |
| **メッセージ本文** | `<pre>` 要素内のテキスト（引用・返信バッジ等を除外） |
| **引用メッセージ** | `[data-cwtag^="[qt"]`、`.chatQuote` 要素 |
| **To宛先** | `[data-cwtag^="[to"]` 要素 |
| **送信者AID** | `[data-aid]` 属性、またはアバターURL から抽出 |

### 連続投稿時のユーザー名処理

ChatWorkでは連続投稿時にユーザー名が省略されるため、以下のロジックで補完：

- ユーザー名が取得できない場合、直前のメッセージのユーザー名を使用
- アバターURLも同様に引き継ぎ

### メッセージセグメント

メッセージ内のテキストと引用の順序を保持するため、セグメント単位で管理：

- **textセグメント**: 通常のテキスト部分
- **quoteセグメント**: 引用部分（発言者情報、外部リンク情報を含む）

これにより、「テキスト→引用→テキスト」のような複雑な構造も正確に再現。

### 自分判定ロジック

#### 自分宛てメッセージ (isToMe)

以下のいずれかの条件でtrueと判定：

1. メッセージ要素に `mentioned` クラスがある
2. クラス名に `mention` を含む（styled-components対応）
3. 親要素に `timelineMessage--mention` クラスがある

#### 自分が送信したメッセージ (isFromMe)

以下のいずれかの条件でtrueと判定：

1. 編集ボタン（`[data-testid="message-edit-button"]` 等）が存在する
2. 削除ボタン（`[data-testid="message-delete-button"]` 等）が存在する
3. 親要素に `myMessage`、`my-message` 等のクラスがある

### スレッド構築アルゴリズム

1. 全メッセージを収集し、`mid` をキーとしたMapに格納
2. 返信関係（`parentMid`）を解析し、`replyMap`（子→親）と`childrenMap`（親→子リスト）を構築
3. ルートメッセージ（親を持たないメッセージ）を起点にツリーを再帰構築
4. 返信元が見つからない場合はプレースホルダーメッセージを生成

### プレースホルダーメッセージ

返信元メッセージがDOMに存在しない場合（スクロール範囲外、削除済み等）：

- **ユーザー名**: 子メッセージの `parentUserName` または「不明なユーザー」
- **メッセージ本文**: 「（メッセージを読み込めませんでした）」
- **表示スタイル**: 半透明、イタリック体、クリック無効

### MutationObserver

以下のDOM変更を監視して自動更新：

- **メッセージ追加/削除**: `data-mid` 属性を持つ要素の変更
- **ルーム切り替え**: URL（ハッシュ）の変更
- **デバウンス**: 500ms間隔で処理を間引き
- **自己変更除外**: 拡張機能自身が追加した要素の変更は無視

### 初期化タイミング

- **ページ読み込み**: `document_idle`（DOMContentLoaded後）で開始
- **メッセージ検出**: 1秒間隔で`data-mid`属性を持つ要素をチェック
- **タイムアウト**: 30秒経過してもメッセージが見つからない場合は初期化を中止
- **ボタン追加遅延**: 初期化完了後1秒待ってから「スレッドで表示」ボタンを追加

---

## 🚀 使い方

### 基本操作

1. ChatWork（https://www.chatwork.com/）にアクセス
2. チャットルームを開く
3. 右下に表示されるトグルボタンをクリック（または `Shift + S`）
4. 右側にスレッドパネルが開く
5. スレッド内のメッセージをクリックすると、該当メッセージにスクロール

### スクロール・ハイライト動作

#### スレッドパネル内のメッセージをクリックした場合（ChatWork本体へのスクロール）

1. メッセージが画面上端に来るようにスムーズスクロール
2. 要素が50%以上表示され、スクロールが200ms停止したら揺れアニメーション開始
3. 左右に5px揺れる動作を**3回**繰り返し
4. 揺れ終了後、青色から透明へのフェードハイライト（1.5秒）
5. 最大8秒でタイムアウト（スクロールが完了しなくても強制実行）

#### 「スレッドで表示」ボタンをクリックした場合（スレッドパネル内へのスクロール）

1. スレッドパネルが閉じていれば開く
2. 該当スレッドの折りたたみを展開
3. メッセージが画面下端に来るようにスムーズスクロール
4. 左右に5px揺れる動作を**2回**繰り返し

### フィルタリング

1. **発言者フィルター**: ヘッダーのプルダウンから特定ユーザーを選択
2. **自分参加フィルター**: 「My Participation Only」をONにして自分が関わるスレッドのみ表示
3. **フラットモード**: 「Flat」をONにして深いネストを簡略化

### 検索

1. 検索バーにキーワードを入力
2. マッチしたメッセージが黄色でハイライト
3. ▲/▼ボタンで結果間を移動

---

## 📦 インストール方法

### 開発者モードでのインストール

1. このリポジトリをクローン
   ```bash
   git clone https://github.com/blocquality/ChatWorkThreader.git
   ```

2. Chromeで `chrome://extensions/` を開く

3. 右上の「デベロッパーモード」をONにする

4. 「パッケージ化されていない拡張機能を読み込む」をクリック

5. クローンしたフォルダを選択

---

## 📁 ファイル構成

```
ChatWorkThreader/
├── manifest.json      # 拡張機能マニフェスト（Manifest V3）
│ ├── content.js         # コンテンツスクリプト（約5600行）
│ ├── styles.css         # スタイルシート
│ ├── popup.html         # ツールバーアイコンクリック時のポップアップ
│ ├── popup.js           # ポップアップのスクリプト
├── icon128.png        # 拡張機能アイコン（128x128、ルート配置）
├── icons/             # アイコン画像ディレクトリ
│   ├── icon16.png     # ファビコン用（16x16）
│   ├── icon48.png     # 拡張機能管理画面用（48x48）
│   └── icon128.png    # Chrome Web Store用（128x128）
└── README.md          # このドキュメント
```

### 主要クラス構成（content.js）

| クラス/関数 | 役割 |
|-------------|------|
| `ThreadBuilder` | メッセージ収集・スレッド構築ロジック |
| `ThreadUI` | パネルUI管理・描画・イベント処理 |
| `ShowInThreadButtonManager` | 「スレッドで表示」ボタンの追加・管理 |
| `createToggleButton()` | トグルボタンの作成 |
| `setupShortcutKey()` | ショートカットキーの設定 |
| `observeMessages()` | MutationObserverによる監視 |
| `init()` | 初期化処理 |

---

## 🛠️ 開発

### 前提条件

- Chrome / Edge などのChromiumベースブラウザ
- Git

### ローカル開発

1. コードを編集
2. `chrome://extensions/` で拡張機能を再読み込み（更新ボタンをクリック）
3. ChatWorkのページをリロードして動作確認

### デバッグ

- 開発者ツール（F12）のConsoleでログを確認
- `console.log` 文はコメントアウト済み（必要に応じて有効化）

---

## 🔧 Manifest V3 設定

```json
{
  "manifest_version": 3,
  "name": "ChatWork Threader",
  "version": "1.0.2",
  "description": "Visualize ChatWork reply threads as a tree to track complex conversations at a glance and streamline teamwork.",
  "permissions": ["storage"],
  "host_permissions": ["https://www.chatwork.com/*"],
  "content_scripts": [{
    "matches": ["https://www.chatwork.com/*"],
    "js": ["content.js"],
    "css": ["styles.css"],
    "run_at": "document_idle"
  }],
  "action": {
    "default_popup": "popup.html"
  },
  "icons": {
    "128": "icon128.png"
  },
  "web_accessible_resources": [{
    "resources": [
      "icons/chat-round-line-svgrepo-com.svg",
      "icons/settings-svgrepo-com.svg",
      "icons/book-minimalistic-svgrepo-com.svg",
      "icons/user-svgrepo-com.svg",
      "icons/layers-minimalistic-svgrepo-com.svg",
      "icons/maximize-square-minimalistic-svgrepo-com.svg",
      "icons/minimize-square-minimalistic-svgrepo-com.svg",
      "icons/add-square-svgrepo-com.svg",
      "icons/minus-square-svgrepo-com.svg",
      "icons/align-left-svgrepo-com.svg",
      "icons/refresh-svgrepo-com.svg"
    ],
    "matches": ["https://www.chatwork.com/*"]
  }]
}
```

### 権限の説明

| 権限 | 用途 |
|------|------|
| `storage` | 設定・状態の永続化（chrome.storage.local） |
| `host_permissions` | https://www.chatwork.com/* へのアクセス |

---

## 📝 メッセージの種類

| 種類 | 内部タイプ値 | 説明 |
|------|-------------|------|
| 独立メッセージ | 1 | スレッドに含まれない独立したメッセージ（パネルには表示されない） |
| 返信元 (Root) | 2 | 誰かから返信がついているメッセージ |
| 返信 (Reply) | 3 | 他のメッセージに対する返信 |
| 返信元+返信 (Both) | 4 | 返信でありかつ、さらに返信がついているメッセージ |

---

## 🔄 更新履歴

### v1.0.2

- ピン止め機能（スレッドをピン止めして上部に固定表示）
- 元メッセージ追跡機能（スクロール範囲外の返信元を高速スクロールで探索）
- メッセージコピーボタン
- 設定パネル（言語 / テーマ / 折りたたみ行数）
- ヘルプパネル（使い方 / 機能一覧 / バッジ説明）
- タブUI（スレッド / 設定 / ヘルプ）
- 多言語対応（日本語 / English）
- テーマ切り替え（ライト / ダーク / システム連動）
- 折りたたみ時の最大行数制限設定
- ピン止めスレッド優先ソート
- 「スレッドで表示」ボタン（ChatWork本体のメッセージ上にホバー表示）
- プレースホルダーメッセージ（返信元が未読み込み時の仮表示）
- 引用メッセージのセグメント表示
- To/Reターゲットのアバター付き表示
- プレビュー時パネル自動非表示
- 不完全データ検出・自動リトライ
- popup.jsからの設定同期

### v1.0.0

- 初回リリース
- スレッドツリー表示機能
- 発言者フィルター
- 自分参加フィルター
- フラットモード
- 検索機能
- ファイル/リンクプレビュー連携
- ショートカットキー対応
- ルーム別設定保存

---

## 📜 ライセンス

MIT License

### サードパーティ素材

本拡張機能で使用しているアイコンは、[SVG Repo](https://www.svgrepo.com/) で公開されている **Solar Linear Icons** コレクション（by [480 Design](https://www.svgrepo.com/author/480%20Design/)）を使用しています。

- **ライセンス**: [CC Attribution License (CC BY 4.0)](https://creativecommons.org/licenses/by/4.0/)

| アイコン名 | ソース |
|-----------|--------|
| Chat Round Line | https://www.svgrepo.com/svg/529480/chat-round-line |
| GPS | https://www.svgrepo.com/svg/524610/gps |
| Copy | https://www.svgrepo.com/svg/528917/copy |
| Pin | https://www.svgrepo.com/svg/529135/pin |
| Settings | https://www.svgrepo.com/svg/529867/settings |
| Book Minimalistic | https://www.svgrepo.com/svg/529408/book-minimalistic |
| Layers Minimalistic | https://www.svgrepo.com/svg/529043/layers-minimalistic |
| User | https://www.svgrepo.com/svg/529293/user |
| Align Left | https://www.svgrepo.com/svg/528841/align-left |
| Refresh | https://www.svgrepo.com/svg/529799/refresh |
| Add Square | https://www.svgrepo.com/svg/529372/add-square |
| Minus Square | https://www.svgrepo.com/svg/529080/minus-square |
| Maximize Square Minimalistic | https://www.svgrepo.com/svg/529063/maximize-square-minimalistic |
| Minimize Square Minimalistic | https://www.svgrepo.com/svg/529072/minimize-square-minimalistic |

---

## 🤝 コントリビューション

Issue や Pull Request は歓迎します！

### バグ報告

1. 再現手順を明記
2. 期待される動作と実際の動作を記載
3. ブラウザのバージョンを記載

### 機能提案

1. 提案する機能の概要
2. ユースケース・利用シーン
3. 可能であれば実装方針
